{% extends "layout.html" %}
{% block content %}
<div class="max-w-6xl mx-auto">
  <!-- Initial Form View -->
  <div id="form-view">
    <!-- Header Section -->
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-gray-800 mb-4">ğŸ©º Diabetes Risk Assessment</h1>
      <p class="text-lg text-gray-600">Enter your health metrics for personalized diabetes risk analysis</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Form Section -->
      <div class="lg:col-span-2">
        <div class="neumorphic-card">
          <form id="predict-form" class="neumorphic-form space-y-3">
            <div class="text-center mb-6">
              <h2 class="text-2xl font-bold form-title">Health Metrics Form</h2>
              <p class="text-sm text-gray-500 mt-2">Please fill in all fields accurately</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <!-- Pregnancies -->
              <div class="space-y-2">
                <label class="input-label flex items-center">
                  <span class="text-lg mr-2">ğŸ¤±</span>
                  Pregnancies <span class="text-xs ml-1">(0-10)</span>
                </label>
                <input name="pregnancies" type="number" min="0" max="10" placeholder="e.g., 1" required class="focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-blue-300 transition-all duration-200 focus:bg-blue-50 hover:bg-gray-50 focus:shadow-lg">
              </div>
              
              <!-- Glucose -->
              <div class="space-y-2">
                <label class="input-label flex items-center">
                  <span class="text-lg mr-2">ğŸ©¸</span>
                  Glucose Level <span class="text-xs ml-1">(mg/dL)</span>
                </label>
                <input name="glucose" type="number" min="70" max="300" placeholder="e.g., 148" required class="focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-blue-300 transition-all duration-200 focus:bg-blue-50 hover:bg-gray-50 focus:shadow-lg">
                <div class="text-xs text-gray-500 px-4">Normal: 70-99 | Prediabetic: 100-125 | Diabetic: 126+</div>
              </div>
              
              <!-- Blood Pressure -->
              <div class="space-y-2">
                <label class="input-label flex items-center">
                  <span class="text-lg mr-2">ğŸ’“</span>
                  Blood Pressure <span class="text-xs ml-1">(mmHg)</span>
                </label>
                <input name="blood_pressure" type="number" min="60" max="200" placeholder="e.g., 72" required class="focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-blue-300 transition-all duration-200 focus:bg-blue-50 hover:bg-gray-50 focus:shadow-lg">
                <div class="text-xs text-gray-500 px-4">Normal: <120 | High: 130+</div>
              </div>
              
              <!-- Insulin -->
              <div class="space-y-2">
                <label class="input-label flex items-center">
                  <span class="text-lg mr-2">ğŸ’‰</span>
                  Insulin Level <span class="text-xs ml-1">(Î¼U/mL)</span>
                </label>
                <input name="insulin" type="number" min="0" max="200" placeholder="e.g., 0" required class="focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-blue-300 transition-all duration-200 focus:bg-blue-50 hover:bg-gray-50 focus:shadow-lg">
              </div>
              
              <!-- BMI -->
              <div class="space-y-2">
                <label class="input-label flex items-center">
                  <span class="text-lg mr-2">âš–</span>
                  Body Mass Index <span class="text-xs ml-1">(BMI)</span>
                </label>
                <input name="bmi" type="number" step="0.1" min="15" max="50" placeholder="e.g., 33.6" required class="focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-blue-300 transition-all duration-200 focus:bg-blue-50 hover:bg-gray-50 focus:shadow-lg">
                <div class="text-xs text-gray-500 px-4">Normal: 18.5-24.9 | Overweight: 25-29.9 | Obese: 30+</div>
              </div>
              
              <!-- Age -->
              <div class="space-y-2">
                <label class="input-label flex items-center">
                  <span class="text-lg mr-2">ğŸ‚</span>
                  Age <span class="text-xs ml-1">(years)</span>
                </label>
                <input name="age" type="number" min="18" max="100" placeholder="e.g., 50" required class="focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-blue-300 transition-all duration-200 focus:bg-blue-50 hover:bg-gray-50 focus:shadow-lg">
              </div>
            </div>
            
            <!-- Family Diabetes History - Centered -->
            <div class="flex justify-center">
              <div class="space-y-2 w-full max-w-md">
                <label class="input-label flex items-center justify-center">
                  <span class="text-lg mr-2">ğŸ‘¨ğŸ‘©ğŸ‘§ğŸ‘¦</span>
                  Family Members with Diabetes <span class="text-xs ml-1">(count)</span>
                </label>
                <input name="family_diabetes" type="number" min="0" max="10" placeholder="e.g., 2" required class="focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-blue-300 transition-all duration-200 focus:bg-blue-50 hover:bg-gray-50 focus:shadow-lg">
                <div class="text-xs text-gray-500 px-4 text-center">Number of immediate family members with diabetes</div>
              </div>
            </div>
            
            <div class="pt-2">
              <button type="submit" class="red w-full py-3 text-lg font-semibold">
                ğŸ” Analyze My Risk
              </button>
            </div>
          </form>
        </div>
      </div>
      
      <!-- Health Guidelines Panel -->
      <div class="space-y-6">
        <!-- Quick Reference -->
        <div class="neumorphic-card">
          <h3 class="text-xl font-bold text-gray-700 mb-4 flex items-center">
            <span class="text-2xl mr-2">ğŸ“Š</span>
            Health Guidelines
          </h3>
          
          <div class="space-y-4 text-sm">
            <div class="p-3 bg-gradient-to-r from-green-50 to-green-100 rounded-lg">
              <h4 class="font-semibold text-green-800 mb-2">ğŸ©¸ Glucose Levels</h4>
              <div class="space-y-1 text-green-700">
                <div>â€¢ Normal: 70-99 mg/dL</div>
                <div>â€¢ Prediabetic: 100-125 mg/dL</div>
                <div>â€¢ Diabetic: 126+ mg/dL</div>
              </div>
            </div>
            
            <div class="p-3 bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg">
              <h4 class="font-semibold text-blue-800 mb-2">âš– BMI Categories</h4>
              <div class="space-y-1 text-blue-700">
                <div>â€¢ Underweight: <18.5</div>
                <div>â€¢ Normal: 18.5-24.9</div>
                <div>â€¢ Overweight: 25-29.9</div>
                <div>â€¢ Obese: 30+</div>
              </div>
            </div>
            
            <div class="p-3 bg-gradient-to-r from-purple-50 to-purple-100 rounded-lg">
              <h4 class="font-semibold text-purple-800 mb-2">ğŸ’“ Blood Pressure</h4>
              <div class="space-y-1 text-purple-700">
                <div>â€¢ Normal: <120 mmHg</div>
                <div>â€¢ Elevated: 120-129 mmHg</div>
                <div>â€¢ High: 130+ mmHg</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading View -->
  <div id="loading-view" class="hidden">
    <div class="max-w-4xl mx-auto">
      <div class="neumorphic-card p-12 text-center relative overflow-hidden">
        <!-- Background Animation -->
        <div class="absolute inset-0 bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 opacity-50"></div>
        <div class="absolute top-0 left-0 w-full h-full">
          <div class="absolute top-10 left-10 w-20 h-20 bg-blue-200 rounded-full opacity-30 animate-pulse"></div>
          <div class="absolute top-20 right-20 w-16 h-16 bg-purple-200 rounded-full opacity-40 animate-bounce"></div>
          <div class="absolute bottom-20 left-20 w-12 h-12 bg-pink-200 rounded-full opacity-35 animate-ping"></div>
        </div>
        
        <!-- Main Content -->
        <div class="relative z-10">
          <!-- DNA Helix Animation -->
          <div class="mb-8 flex justify-center">
            <div class="relative w-24 h-24">
              <div class="absolute inset-0 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
              <div class="absolute inset-2 border-4 border-purple-500 border-b-transparent rounded-full animate-spin" style="animation-direction: reverse; animation-duration: 1.5s;"></div>
              <div class="absolute inset-4 border-4 border-pink-500 border-l-transparent rounded-full animate-spin" style="animation-duration: 2s;"></div>
              <div class="absolute inset-0 flex items-center justify-center">
                <div class="w-4 h-4 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full animate-pulse"></div>
              </div>
            </div>
          </div>
          
          <!-- Title with Gradient -->
          <h2 class="text-3xl font-bold bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 bg-clip-text text-transparent mb-4">
            ğŸ§¬ HealthScope AI Analysis
          </h2>
          
          <!-- Subtitle -->
          <p class="text-gray-600 mb-8 text-lg">Advanced machine learning algorithms at work</p>
          
          <!-- Progress Circle -->
          <div class="relative w-32 h-32 mx-auto mb-8">
            <svg class="w-32 h-32 transform -rotate-90" viewBox="0 0 100 100">
              <circle cx="50" cy="50" r="40" stroke="#e5e7eb" stroke-width="8" fill="none"/>
              <circle id="loading-progress-circle" cx="50" cy="50" r="40" stroke="url(#gradient)" stroke-width="8" fill="none" 
                      stroke-linecap="round" stroke-dasharray="251.2" stroke-dashoffset="251.2" class="transition-all duration-500">
                <defs>
                  <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:1" />
                    <stop offset="50%" style="stop-color:#8b5cf6;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#ec4899;stop-opacity:1" />
                  </linearGradient>
                </defs>
              </circle>
            </svg>
            <div class="absolute inset-0 flex items-center justify-center">
              <span id="loading-percentage" class="text-2xl font-bold text-gray-800">0%</span>
            </div>
          </div>
          
          <!-- Loading Steps -->
          <div class="space-y-4 mb-8">
            <div id="step-1" class="flex items-center justify-center space-x-3 opacity-30 transition-all duration-500">
              <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
              <span class="text-sm font-medium">Processing Health Metrics</span>
            </div>
            <div id="step-2" class="flex items-center justify-center space-x-3 opacity-30 transition-all duration-500">
              <div class="w-3 h-3 bg-purple-500 rounded-full"></div>
              <span class="text-sm font-medium">Running ML Algorithms</span>
            </div>
            <div id="step-3" class="flex items-center justify-center space-x-3 opacity-30 transition-all duration-500">
              <div class="w-3 h-3 bg-pink-500 rounded-full"></div>
              <span class="text-sm font-medium">Analyzing Risk Factors</span>
            </div>
            <div id="step-4" class="flex items-center justify-center space-x-3 opacity-30 transition-all duration-500">
              <div class="w-3 h-3 bg-green-500 rounded-full"></div>
              <span class="text-sm font-medium">Generating Results</span>
            </div>
          </div>
          
          <!-- Status Text -->
          <p id="loading-status" class="text-sm text-gray-500 animate-pulse">Initializing AI models...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Results View -->
  <div id="results-view" class="hidden">
    <div class="max-w-4xl mx-auto">
      <div class="neumorphic-card p-8">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <!-- Left Side: Risk Level & Circle -->
          <div class="text-center">
            <h2 class="text-lg font-medium text-gray-600 mb-4">Predicted Risk Level</h2>
            <h1 id="risk-title" class="text-4xl font-bold text-orange-500 mb-6">Moderate Risk</h1>
            
            <!-- Circular Progress -->
            <div class="relative w-48 h-48 mx-auto mb-6">
              <svg class="w-48 h-48 transform -rotate-90" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="40" stroke="#e5e7eb" stroke-width="8" fill="none"/>
                <circle id="progress-circle" cx="50" cy="50" r="40" stroke="#f59e0b" stroke-width="8" fill="none" 
                        stroke-linecap="round" stroke-dasharray="251.2" stroke-dashoffset="125.6"/>
              </svg>
              <div class="absolute inset-0 flex items-center justify-center">
                <span id="risk-percentage" class="text-4xl font-bold text-gray-800">54%</span>
              </div>
            </div>
            
            <!-- Prediction Result -->
            <div class="text-center mb-6">
              <h3 class="text-lg font-semibold text-gray-700 mb-2">Prediction Result</h3>
              <div id="prediction-result" class="text-2xl font-bold text-red-600">Diabetic</div>
            </div>
            
            <!-- Key Factors -->
            <div class="text-left">
              <h3 class="text-lg font-semibold text-gray-700 mb-3">Key Factors</h3>
              <p id="key-factors-text" class="text-gray-600 text-sm">Your Glucose and BMI levels were primary factors in this prediction.</p>
            </div>
          </div>
          
          <!-- Right Side: BMI, Glucose & Advice -->
          <div class="space-y-6">
            <!-- BMI Bar -->
            <div>
              <div class="flex justify-between items-center mb-2">
                <span class="text-gray-700 font-medium">Your BMI</span>
                <span id="bmi-value" class="font-bold text-red-600">33.6 Obese</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-3 relative">
                <div class="h-3 rounded-full bg-gradient-to-r from-blue-400 via-green-400 via-yellow-400 to-red-500"></div>
                <div id="bmi-indicator" class="absolute w-1 h-5 bg-black top-0 rounded" style="left: 80%;"></div>
              </div>
            </div>
            
            <!-- Glucose Bar -->
            <div>
              <div class="flex justify-between items-center mb-2">
                <span class="text-gray-700 font-medium">Your Glucose</span>
                <span id="glucose-value" class="font-bold text-red-600">148 mg/dL Diabetes</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-3 relative">
                <div class="h-3 rounded-full bg-gradient-to-r from-green-400 via-yellow-400 to-red-500"></div>
                <div id="glucose-indicator" class="absolute w-1 h-5 bg-black top-0 rounded" style="left: 70%;"></div>
              </div>
            </div>
            
            <!-- Personalized Advice -->
            <div class="mt-8">
              <h3 class="text-lg font-semibold text-gray-700 mb-4">Personalized Advice</h3>
              <div id="advice-list" class="space-y-3">
                <!-- Dynamic content will be populated here -->
              </div>
            </div>
            
            <!-- Health Tips -->
            <div class="mt-8">
              <h3 class="text-lg font-semibold text-gray-700 mb-4">Health Tips</h3>
              <div class="space-y-3">
                <!-- Dynamic content will be populated here -->
              </div>
            </div>
            
            <!-- What to Avoid -->
            <div class="mt-8">
              <h3 class="text-lg font-semibold text-gray-700 mb-4">What to Avoid</h3>
              <div class="space-y-3">
                <!-- Dynamic content will be populated here -->
              </div>
            </div>
          </div>
        </div>
        
        <!-- Try Again Button -->
        <div class="text-center mt-8">
          <button id="try-again-btn" class="px-8 py-3 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-colors">
            Try Again
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Auth Required Modal -->
<div id="auth-modal" class="fixed inset-0 hidden flex items-center justify-center z-50 p-4">
  <div class="neumorphic-card max-w-md w-full bg-white relative overflow-hidden">
    <!-- Background Animation -->
    <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-blue-100 to-purple-100 rounded-full opacity-50 -translate-y-16 translate-x-16"></div>
    <div class="absolute bottom-0 left-0 w-24 h-24 bg-gradient-to-tr from-pink-100 to-yellow-100 rounded-full opacity-40 translate-y-12 -translate-x-12"></div>
    
    <div class="relative z-10 p-8 text-center">
      <!-- Icon -->
      <div class="w-20 h-20 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-6">
        <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
        </svg>
      </div>
      
      <!-- Title -->
      <h3 class="text-2xl font-bold text-gray-800 mb-4">Authentication Required</h3>
      
      <!-- Message -->
      <p class="text-gray-600 mb-8 leading-relaxed">
        Please log in to access the diabetes risk prediction feature and save your health analysis results.
      </p>
      
      <!-- Buttons -->
      <div class="flex flex-col sm:flex-row gap-3">
        <a href="/login" class="flex-1 bg-gradient-to-r from-blue-500 to-purple-600 text-white px-6 py-3 rounded-lg font-semibold hover:from-blue-600 hover:to-purple-700 transition-all duration-200 flex items-center justify-center space-x-2">
          <span>ğŸ”</span>
          <span>Login</span>
        </a>
        <a href="/register" class="flex-1 bg-gray-100 text-gray-700 px-6 py-3 rounded-lg font-semibold hover:bg-gray-200 transition-colors flex items-center justify-center space-x-2">
          <span>âœ¨</span>
          <span>Register</span>
        </a>
      </div>
      
      <!-- Close Button -->
      <button onclick="closeAuthModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
  </div>
</div>

<script>
function showAuthModal() {
  document.getElementById('auth-modal').classList.remove('hidden');
  document.getElementById('auth-modal').classList.add('flex');
}

function closeAuthModal() {
  document.getElementById('auth-modal').classList.add('hidden');
  document.getElementById('auth-modal').classList.remove('flex');
}

// Close modal when clicking outside
document.getElementById('auth-modal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeAuthModal();
  }
});

const advice = {
  high: [
    { icon: 'ğŸ´', text: 'Focus on a balanced diet with controlled carbs.' },
    { icon: 'ğŸƒ', text: 'Aim for 30 minutes of moderate activity daily.' },
    { icon: 'ğŸ‘¨âš•', text: 'Consult a doctor to discuss these results.' }
  ],
  moderate: [
    { icon: 'ğŸ', text: 'Incorporate more fruits, vegetables, and whole grains.' },
    { icon: 'ğŸ’§', text: 'Ensure you are staying well-hydrated.' },
    { icon: 'ğŸ—“', text: 'Consider regular monitoring and a check-up.' }
  ],
  low: [
    { icon: 'ğŸ‘', text: 'You\'re doing great! Keep up the healthy lifestyle.' },
    { icon: 'ğŸ’ª', text: 'Continue with your consistent physical activity.' },
    { icon: 'ğŸ¥—', text: 'Maintain your balanced and nutritious diet.' }
  ]
};

const healthTips = {
  high: [
    { icon: 'ğŸš«', text: 'Avoid sugary drinks and processed foods' },
    { icon: 'â°', text: 'Monitor blood sugar levels regularly' },
    { icon: 'ğŸ’Š', text: 'Take medications as prescribed by doctor' },
    { icon: 'ğŸ©º', text: 'Schedule regular medical check-ups' }
  ],
  moderate: [
    { icon: 'ğŸƒâ™‚', text: 'Regular exercise improves insulin sensitivity' },
    { icon: 'ğŸ¥—', text: 'Balanced diet helps manage blood sugar' },
    { icon: 'ğŸ’§', text: 'Stay hydrated for better health' },
    { icon: 'ğŸ˜´', text: 'Quality sleep regulates hormones' }
  ],
  low: [
    { icon: 'ğŸ¯', text: 'Maintain current healthy habits' },
    { icon: 'ğŸ‡', text: 'Continue eating nutritious foods' },
    { icon: 'ğŸš¶', text: 'Keep up regular physical activity' },
    { icon: 'ğŸ“Š', text: 'Annual health screenings recommended' }
  ]
};

const avoidanceTips = {
  high: [
    { icon: 'ğŸš«', text: 'Completely avoid sugary beverages' },
    { icon: 'ğŸ°', text: 'Eliminate desserts and sweets' },
    { icon: 'ğŸš¬', text: 'Stop smoking immediately' },
    { icon: 'ğŸº', text: 'Avoid alcohol consumption' }
  ],
  moderate: [
    { icon: 'ğŸš«', text: 'Avoid sugary drinks and processed foods' },
    { icon: 'ğŸŸ', text: 'Limit fried and high-fat foods' },
    { icon: 'ğŸš¬', text: 'Avoid smoking and excessive alcohol' },
    { icon: 'â°', text: 'Don\'t skip meals or eat irregularly' }
  ],
  low: [
    { icon: 'ğŸ­', text: 'Limit sugary snacks and treats' },
    { icon: 'ğŸ¥¤', text: 'Reduce soft drink consumption' },
    { icon: 'ğŸ•', text: 'Minimize fast food intake' },
    { icon: 'ğŸ˜´', text: 'Avoid irregular sleep patterns' }
  ]
};

function getBMICategory(bmi) {
  if (bmi < 18.5) return { category: 'Underweight', color: 'blue' };
  if (bmi < 25) return { category: 'Normal', color: 'green' };
  if (bmi < 30) return { category: 'Overweight', color: 'yellow' };
  return { category: 'Obese', color: 'red' };
}

function getGlucoseCategory(glucose) {
  if (glucose < 100) return { category: 'Normal', color: 'green' };
  if (glucose < 126) return { category: 'Prediabetes', color: 'yellow' };
  return { category: 'Diabetes', color: 'red' };
}

function updateResults(data, result) {
  const riskPercent = (result.probability * 100).toFixed(0);
  const riskLevel = riskPercent > 66 ? 'High Risk' : riskPercent >= 33 ? 'Moderate Risk' : 'Low Risk';
  const riskColor = riskPercent > 66 ? '#ef4444' : riskPercent > 33 ? '#f59e0b' : '#10b981';
  
  // Update risk title and percentage
  document.getElementById('risk-title').textContent = riskLevel;
  document.getElementById('risk-title').style.color = riskColor;
  document.getElementById('risk-percentage').textContent = riskPercent + '%';
  
  // Update circular progress
  const circumference = 2 * Math.PI * 40;
  const offset = circumference - (riskPercent / 100) * circumference;
  const circle = document.getElementById('progress-circle');
  circle.style.stroke = riskColor;
  circle.style.strokeDashoffset = offset;
  
  // Update BMI
  const bmiInfo = getBMICategory(parseFloat(data.bmi));
  document.getElementById('bmi-value').textContent = ${data.bmi} ${bmiInfo.category};
  document.getElementById('bmi-value').className = font-bold text-${bmiInfo.color}-600;
  
  // Position BMI indicator (rough calculation)
  const bmiPosition = Math.min(90, Math.max(10, (parseFloat(data.bmi) - 15) / 35 * 100));
  document.getElementById('bmi-indicator').style.left = bmiPosition + '%';
  
  // Update Glucose
  const glucoseInfo = getGlucoseCategory(parseFloat(data.glucose));
  document.getElementById('glucose-value').textContent = ${data.glucose} mg/dL ${glucoseInfo.category};
  document.getElementById('glucose-value').className = font-bold text-${glucoseInfo.color}-600;
  
  // Position glucose indicator
  const glucosePosition = Math.min(90, Math.max(10, (parseFloat(data.glucose) - 70) / 230 * 100));
  document.getElementById('glucose-indicator').style.left = glucosePosition + '%';
  
  // Update sections based on risk percentage: >66% = high, 33-66% = moderate, <33% = low
  const adviceLevel = riskPercent > 66 ? 'high' : riskPercent >= 33 ? 'moderate' : 'low';
  
  // Health Tips section uses advice object
  const healthTipsList = document.querySelector('#results-view .mt-8:nth-last-of-type(2) .space-y-3');
  healthTipsList.innerHTML = advice[adviceLevel].map(item => `
    <div class="flex items-start space-x-2 sm:space-x-3">
      <span class="text-lg sm:text-xl">${item.icon}</span>
      <p class="text-gray-600 text-xs sm:text-sm">${item.text}</p>
    </div>
  `).join('');
  
  // Personalized Advice section uses healthTips object
  const adviceList = document.getElementById('advice-list');
  adviceList.innerHTML = healthTips[adviceLevel].map(item => `
    <div class="flex items-start space-x-3">
      <span class="text-xl">${item.icon}</span>
      <p class="text-gray-600 text-sm">${item.text}</p>
    </div>
  `).join('');
  
  // What to Avoid section uses avoidanceTips object
  const avoidanceList = document.querySelector('#results-view .mt-8:last-of-type .space-y-3');
  avoidanceList.innerHTML = avoidanceTips[adviceLevel].map(item => `
    <div class="flex items-start space-x-2 sm:space-x-3">
      <span class="text-lg sm:text-xl">${item.icon}</span>
      <p class="text-gray-600 text-xs sm:text-sm">${item.text}</p>
    </div>
  `).join('');
  
  // Update prediction result
  const predictionText = result.prediction ? 'Diabetic' : 'Non-Diabetic';
  const predictionColor = result.prediction ? 'text-red-600' : 'text-green-600';
  document.getElementById('prediction-result').textContent = predictionText;
  document.getElementById('prediction-result').className = text-2xl font-bold ${predictionColor};
  
  // Update key factors
  document.getElementById('key-factors-text').textContent = 
    Your Glucose and BMI levels were primary factors in this prediction.;
}

document.getElementById("predict-form").addEventListener("submit", async (e) => {
  e.preventDefault();
  
  const submitBtn = e.target.querySelector('button[type="submit"]');
  const originalText = submitBtn.innerHTML;
  submitBtn.innerHTML = 'ğŸ”„ Analyzing...';
  submitBtn.disabled = true;
  
  // Show loading screen
  document.getElementById("form-view").classList.add("hidden");
  document.getElementById("loading-view").classList.remove("hidden");
  
  // Simulate loading progress with advanced animations
  const loadingSteps = [
    { progress: 25, step: 1, text: 'Initializing neural networks...' },
    { progress: 50, step: 2, text: 'Processing health data...' },
    { progress: 75, step: 3, text: 'Computing risk probabilities...' },
    { progress: 100, step: 4, text: 'Finalizing analysis...' }
  ];
  
  for (let i = 0; i < loadingSteps.length; i++) {
    await new Promise(resolve => setTimeout(resolve, 200));
    
    // Update progress circle
    const circumference = 2 * Math.PI * 40;
    const offset = circumference - (loadingSteps[i].progress / 100) * circumference;
    document.getElementById('loading-progress-circle').style.strokeDashoffset = offset;
    document.getElementById('loading-percentage').textContent = loadingSteps[i].progress + '%';
    
    // Activate current step
    document.getElementById(step-${loadingSteps[i].step}).style.opacity = '1';
    document.getElementById(step-${loadingSteps[i].step}).style.transform = 'scale(1.05)';
    
    // Update status text
    document.getElementById('loading-status').textContent = loadingSteps[i].text;
  }
  
  try {
    const data = Object.fromEntries(new FormData(e.target).entries());
    const res = await fetch("/api/predict", {
      method: "POST",
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(data)
    });
    const result = await res.json();
    
    if (result.error) {
      if (result.error.includes('auth required')) {
        showAuthModal();
      } else {
        alert('âš  ' + result.error);
      }
      document.getElementById("loading-view").classList.add("hidden");
      document.getElementById("form-view").classList.remove("hidden");
      return; 
    }

    // Hide loading, show results
    document.getElementById("loading-view").classList.add("hidden");
    document.getElementById("results-view").classList.remove("hidden");
    
    // Update results display
    updateResults(data, result);
    
  } catch (error) {
    alert('âš  Connection error. Please try again.');
    document.getElementById("loading-view").classList.add("hidden");
    document.getElementById("form-view").classList.remove("hidden");
  } finally {
    submitBtn.innerHTML = originalText;
    submitBtn.disabled = false;
  }
});

// Try again button
document.getElementById('try-again-btn').addEventListener('click', () => {
  document.getElementById("predict-form").reset();
  document.getElementById("form-view").classList.remove("hidden");
  document.getElementById("results-view").classList.add("hidden");
});
</script>
{% endblock %}